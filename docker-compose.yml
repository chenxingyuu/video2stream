version: "3.8"

services:
  zlmediakit:
    image: zlmediakit/zlmediakit:master
    container_name: zlmediakit
    restart: unless-stopped
    ports:
      - "1935:1935"   # RTMP
      - "554:554"     # RTSP
      - "8000:80"     # Web 管理 / API（镜像内部默认 80）
      - "8080:8080"   # HTTP-FLV / HLS 等

  video2stream-watcher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: video2stream-watcher
    restart: unless-stopped
    depends_on:
      - zlmediakit
    ports:
      - "8081:8081"   # HTTP API 端口
    environment:
      # 可根据需要在这里覆盖配置
      # 监听目录（容器内路径）
      - VIDEO_DIR=/app/videos
      # 推流基础地址（不含流名），默认指向上面的 zlmediakit 服务
      # 实际推流地址：rtmp://zlmediakit:1935/live/{文件名去扩展名}
      - RTMP_URL=rtmp://zlmediakit:1935/live
      # 可选：自定义轮询间隔（秒）
      - POLL_INTERVAL=5
      # HTTP API 端口
      - HTTP_PORT=8081
      # 可选：自定义支持的视频后缀（逗号分隔）
      # - VIDEO_EXTENSIONS=mp4,flv,mkv,mov,avi
      # 可选：失败重试次数（<=0 表示无限重试）
      # - RETRY_MAX_ATTEMPTS=0
      # 可选：ffmpeg 视频编码器配置
      # - FFMPEG_VIDEO_CODEC=copy  # 默认：直接复制，不重新编码（性能最优）
      # - FFMPEG_VIDEO_CODEC=libx264  # 使用 H.264 编码器重新编码
      # - FFMPEG_VIDEO_CODEC="libx264 -preset veryfast -tune zerolatency -threads 0"  # 带编码参数
      # 可选：ffmpeg 视频滤镜配置（如添加时间戳文字）
      # - FFMPEG_VIDEO_FILTER="drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:text='%{localtime}':fontsize=24:fontcolor=white:x=w-tw-10:y=10"
    volumes:
      # 将宿主机的视频目录挂载进容器
      - ./videos:/app/videos


